<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crear Sorteo - Admin</title>
  <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
  <nav>
    <button onclick="location.href='panel.html'">Volver al Panel</button>
    <button onclick="logout()">Salir</button>
  </nav>

  <div class="form">
    <h2>Crear Nuevo Sorteo</h2>
    <label for="imagen">Imagen del sorteo</label>
    <input type="file" id="imagen" accept="image/*">
    <div id="previewImagen" class="imagen-preview oculto">
      <p>Vista previa:</p>
      <img id="imgPreviewAdmin" alt="Preview imagen del sorteo" />
    </div>
    <input type="text" id="descripcion" placeholder="Descripción del sorteo">
    <input type="text" id="premio" placeholder="Premio (ej: $1000 en efectivo)">
    <input type="number" id="cantidad_numeros" placeholder="Total números (ej: 1000)">
    <input type="number" id="precio_numero" placeholder="Precio por número (ej: 50)">
    <input type="datetime-local" id="fecha_sorteo">
    <button class="btn-gold" onclick="crearSorteo()">CREAR SORTEO</button>
  </div>

  <script src="../assets/js/config.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script>
    // Mostrar vista previa de la imagen seleccionada
    (function () {
      const input = document.getElementById('imagen');
      const previewWrapper = document.getElementById('previewImagen');
      const img = document.getElementById('imgPreviewAdmin');

      function resetPreview() {
        img.src = '';
        previewWrapper.classList.add('oculto');
      }

      input.addEventListener('change', () => {
        const file = input.files && input.files[0];
        if (!file) {
          resetPreview();
          return;
        }

        // Validar tipo básico
        if (!file.type.startsWith('image/')) {
          alert('Por favor selecciona un archivo de imagen (jpg, png, etc.).');
          input.value = '';
          resetPreview();
          return;
        }

        // Validar tamaño (ej. 5MB)
        const maxBytes = 5 * 1024 * 1024;
        if (file.size > maxBytes) {
          alert('El archivo es demasiado grande. Máx 5 MB.');
          input.value = '';
          resetPreview();
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          img.src = e.target.result;
          previewWrapper.classList.remove('oculto');
        };
        reader.readAsDataURL(file);
      });
    })();

    async function crearSorteo() {
      const formData = new FormData();
      formData.append('descripcion', document.getElementById('descripcion').value);
      formData.append('premio', document.getElementById('premio').value);
      formData.append('cantidad_numeros', document.getElementById('cantidad_numeros').value);
      formData.append('precio_numero', document.getElementById('precio_numero').value);
      formData.append('fecha_sorteo', document.getElementById('fecha_sorteo').value);

      // AGREGAR IMAGEN SOLO SI EL ADMIN SUBIÓ UNA
      const file = document.getElementById('imagen').files[0];
      if (file) {
        formData.append('imagen', file);
      }

      const token = localStorage.getItem('token');

      const res = await fetch(`${API_URL}/api/sorteos/crear`, {
        method: 'POST',
        headers: { 
          'Authorization': `Bearer ${token}`
          // ⚠️ NO agregar Content-Type aquí.
          // fetch lo maneja automático porque usamos FormData.
        },
        body: formData
      });

      if (res.ok) {
        alert('✅ Sorteo creado!');
        location.href = 'panel.html';
      } else {
        alert('❌ Error al crear sorteo');
      }
    }
  </script>

</body>
</html>